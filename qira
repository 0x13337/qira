#!/bin/bash
set -e

if [ -z $1 ]; then
  echo "usage: $0 <target binary>"
  exit -1
fi

BIN=$(readlink -f $1)
FILE=$(file $BIN)

mkdir -p /tmp/qira_logs/
ln -sf "$BIN" /tmp/qira_binary

# build qemu if we have the source
if [ -d "qemu/qemu-latest" ]; then
  pushd .
  cd qemu/qemu-latest
  make -j32
  popd
fi

shift

# detect which qemu to run based on the file
if [[ $FILE == *SPARC32PLUS* ]]; then
  qira-sparc32plus -singlestep /tmp/qira_binary $@
elif [[ $FILE == *ARM* ]]; then
  qira-arm -singlestep /tmp/qira_binary $@
elif [[ $FILE == *x86-64* ]]; then
  qira-x86_64 -singlestep /tmp/qira_binary $@
else
  qira-i386 -singlestep /tmp/qira_binary $@
fi


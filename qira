#!/bin/bash
set -e

if [ -z $1 ]; then
  echo "usage: $0 <target binary>"
  exit -1
fi

BIN=$(realpath $1)
FILE=$(file $BIN)

ln -sf $BIN /tmp/qira_binary

# build qemu if we have the source
if [ -d "qemu/qemu-latest" ]; then
  pushd .
  cd qemu/qemu-latest
  make -j32
  popd
fi

# detect which qemu to run based on the file
shift
# TODO: use $FILE to detect which qira to call
qira-i386 -singlestep /tmp/qira_binary $@
#qira-sparc32plus -singlestep /tmp/qira_binary $@
#qira-arm -singlestep /tmp/qira_binary $@
#qira-x86_64 -singlestep /tmp/qira_binary $@

